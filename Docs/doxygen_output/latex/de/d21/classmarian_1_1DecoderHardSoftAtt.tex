\hypertarget{classmarian_1_1DecoderHardSoftAtt}{}\section{marian\+:\+:Decoder\+Hard\+Soft\+Att Class Reference}
\label{classmarian_1_1DecoderHardSoftAtt}\index{marian\+::\+Decoder\+Hard\+Soft\+Att@{marian\+::\+Decoder\+Hard\+Soft\+Att}}


{\ttfamily \#include $<$hardatt.\+h$>$}



Inheritance diagram for marian\+:\+:Decoder\+Hard\+Soft\+Att\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[height=550pt]{df/d38/classmarian_1_1DecoderHardSoftAtt__inherit__graph}
\end{center}
\end{figure}


Collaboration diagram for marian\+:\+:Decoder\+Hard\+Soft\+Att\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[height=550pt]{d4/def/classmarian_1_1DecoderHardSoftAtt__coll__graph}
\end{center}
\end{figure}
\subsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
{\footnotesize template$<$class... Args$>$ }\\\hyperlink{classmarian_1_1DecoderHardSoftAtt_a4685d8ba22a7f5b083dd15a7957d97f6}{Decoder\+Hard\+Soft\+Att} (\hyperlink{namespacemarian_ad1a373be43a00ef9ce35666145137b08}{Ptr}$<$ \hyperlink{classmarian_1_1Config}{Config} $>$ options, Args...\+args)
\item 
virtual \hyperlink{namespacemarian_ad1a373be43a00ef9ce35666145137b08}{Ptr}$<$ \hyperlink{classmarian_1_1DecoderState}{Decoder\+State} $>$ \hyperlink{classmarian_1_1DecoderHardSoftAtt_aa3331fae45271298ce86ad6f6a5c9cf5}{step} (\hyperlink{namespacemarian_ad1a373be43a00ef9ce35666145137b08}{Ptr}$<$ \hyperlink{classmarian_1_1ExpressionGraph}{Expression\+Graph} $>$ graph, \hyperlink{namespacemarian_ad1a373be43a00ef9ce35666145137b08}{Ptr}$<$ \hyperlink{classmarian_1_1DecoderState}{Decoder\+State} $>$ state)
\item 
const std\+::vector$<$ \hyperlink{namespacemarian_a498d8baf75b754011078b890b39c8e12}{Expr} $>$ \hyperlink{classmarian_1_1DecoderHardSoftAtt_a39c270be364b3e37f3834f6fc867ac34}{get\+Alignments} ()
\end{DoxyCompactItemize}
\subsection*{Protected Attributes}
\begin{DoxyCompactItemize}
\item 
\hyperlink{namespacemarian_ad1a373be43a00ef9ce35666145137b08}{Ptr}$<$ rnn\+::\+R\+NN $>$ \hyperlink{classmarian_1_1DecoderHardSoftAtt_ae077a0f8f32a457c0c2c972ca4251ede}{rnn\+\_\+}
\end{DoxyCompactItemize}


\subsection{Detailed Description}


Definition at line 236 of file hardatt.\+h.



\subsection{Constructor \& Destructor Documentation}
\index{marian\+::\+Decoder\+Hard\+Soft\+Att@{marian\+::\+Decoder\+Hard\+Soft\+Att}!Decoder\+Hard\+Soft\+Att@{Decoder\+Hard\+Soft\+Att}}
\index{Decoder\+Hard\+Soft\+Att@{Decoder\+Hard\+Soft\+Att}!marian\+::\+Decoder\+Hard\+Soft\+Att@{marian\+::\+Decoder\+Hard\+Soft\+Att}}
\subsubsection[{\texorpdfstring{Decoder\+Hard\+Soft\+Att(\+Ptr$<$ Config $>$ options, Args...\+args)}{DecoderHardSoftAtt(Ptr< Config > options, Args...args)}}]{\setlength{\rightskip}{0pt plus 5cm}template$<$class... Args$>$ marian\+::\+Decoder\+Hard\+Soft\+Att\+::\+Decoder\+Hard\+Soft\+Att (
\begin{DoxyParamCaption}
\item[{{\bf Ptr}$<$ {\bf Config} $>$}]{options, }
\item[{Args...}]{args}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [inline]}}\hypertarget{classmarian_1_1DecoderHardSoftAtt_a4685d8ba22a7f5b083dd15a7957d97f6}{}\label{classmarian_1_1DecoderHardSoftAtt_a4685d8ba22a7f5b083dd15a7957d97f6}


Definition at line 242 of file hardatt.\+h.


\begin{DoxyCode}
243       : \hyperlink{classmarian_1_1DecoderHardAtt_ad3b9d947796bce9562666d12a7ccecc2}{DecoderHardAtt}(options, args...) \{\}
\end{DoxyCode}


\subsection{Member Function Documentation}
\index{marian\+::\+Decoder\+Hard\+Soft\+Att@{marian\+::\+Decoder\+Hard\+Soft\+Att}!get\+Alignments@{get\+Alignments}}
\index{get\+Alignments@{get\+Alignments}!marian\+::\+Decoder\+Hard\+Soft\+Att@{marian\+::\+Decoder\+Hard\+Soft\+Att}}
\subsubsection[{\texorpdfstring{get\+Alignments()}{getAlignments()}}]{\setlength{\rightskip}{0pt plus 5cm}const std\+::vector$<${\bf Expr}$>$ marian\+::\+Decoder\+Hard\+Soft\+Att\+::get\+Alignments (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [inline]}, {\ttfamily [virtual]}}\hypertarget{classmarian_1_1DecoderHardSoftAtt_a39c270be364b3e37f3834f6fc867ac34}{}\label{classmarian_1_1DecoderHardSoftAtt_a39c270be364b3e37f3834f6fc867ac34}


Reimplemented from \hyperlink{classmarian_1_1DecoderHardAtt_a1ab5187807e2cc388a0679785928b103}{marian\+::\+Decoder\+Hard\+Att}.



Reimplemented in \hyperlink{classmarian_1_1MultiDecoderHardSoftAtt_a5663940ea8e359b7af4ebb16380fe01e}{marian\+::\+Multi\+Decoder\+Hard\+Soft\+Att}.



Definition at line 343 of file hardatt.\+h.


\begin{DoxyCode}
343                                         \{
344     \textcolor{keyword}{auto} att = \hyperlink{classmarian_1_1DecoderHardSoftAtt_ae077a0f8f32a457c0c2c972ca4251ede}{rnn\_}->at(0)->as<rnn::StackedCell>()->at(1)->as<\hyperlink{namespacemarian_1_1rnn_ae9586d2236bd64dae0a644c58d9fc76e}{rnn::Attention}>();
345     \textcolor{keywordflow}{return} att->\hyperlink{classmarian_1_1rnn_1_1GlobalAttention_a7fab38ad7965922a7e8eb26f0d4906af}{getAlignments}();
346   \}
\end{DoxyCode}


Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{de/d21/classmarian_1_1DecoderHardSoftAtt_a39c270be364b3e37f3834f6fc867ac34_cgraph}
\end{center}
\end{figure}


\index{marian\+::\+Decoder\+Hard\+Soft\+Att@{marian\+::\+Decoder\+Hard\+Soft\+Att}!step@{step}}
\index{step@{step}!marian\+::\+Decoder\+Hard\+Soft\+Att@{marian\+::\+Decoder\+Hard\+Soft\+Att}}
\subsubsection[{\texorpdfstring{step(\+Ptr$<$ Expression\+Graph $>$ graph, Ptr$<$ Decoder\+State $>$ state)}{step(Ptr< ExpressionGraph > graph, Ptr< DecoderState > state)}}]{\setlength{\rightskip}{0pt plus 5cm}virtual {\bf Ptr}$<${\bf Decoder\+State}$>$ marian\+::\+Decoder\+Hard\+Soft\+Att\+::step (
\begin{DoxyParamCaption}
\item[{{\bf Ptr}$<$ {\bf Expression\+Graph} $>$}]{graph, }
\item[{{\bf Ptr}$<$ {\bf Decoder\+State} $>$}]{state}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [inline]}, {\ttfamily [virtual]}}\hypertarget{classmarian_1_1DecoderHardSoftAtt_aa3331fae45271298ce86ad6f6a5c9cf5}{}\label{classmarian_1_1DecoderHardSoftAtt_aa3331fae45271298ce86ad6f6a5c9cf5}


Reimplemented from \hyperlink{classmarian_1_1DecoderHardAtt_ab938d5649fc73437fa39a462330245bf}{marian\+::\+Decoder\+Hard\+Att}.



Reimplemented in \hyperlink{classmarian_1_1MultiDecoderHardSoftAtt_a9dc01206082f6b287300c2ee6460d3ba}{marian\+::\+Multi\+Decoder\+Hard\+Soft\+Att}.



Definition at line 245 of file hardatt.\+h.


\begin{DoxyCode}
246                                                           \{
247     \textcolor{keyword}{using namespace }\hyperlink{namespacekeywords}{keywords};
248 
249     \textcolor{keywordtype}{int} dimTrgVoc = \hyperlink{classmarian_1_1DecoderBase_a75375e7661a014fd15bbee3b0a047b91}{options\_}->get<std::vector<int>>(\textcolor{stringliteral}{"dim-vocabs"}).back();
250 
251     \textcolor{keywordtype}{int} dimTrgEmb = \hyperlink{classmarian_1_1DecoderBase_a75375e7661a014fd15bbee3b0a047b91}{options\_}->get<\textcolor{keywordtype}{int}>(\textcolor{stringliteral}{"dim-emb"});
252 
253     \textcolor{keywordtype}{int} dimDecState = \hyperlink{classmarian_1_1DecoderBase_a75375e7661a014fd15bbee3b0a047b91}{options\_}->get<\textcolor{keywordtype}{int}>(\textcolor{stringliteral}{"dim-rnn"});
254     \textcolor{keywordtype}{bool} layerNorm = \hyperlink{classmarian_1_1DecoderBase_a75375e7661a014fd15bbee3b0a047b91}{options\_}->get<\textcolor{keywordtype}{bool}>(\textcolor{stringliteral}{"layer-normalization"});
255     \textcolor{keywordtype}{bool} skipDepth = \hyperlink{classmarian_1_1DecoderBase_a75375e7661a014fd15bbee3b0a047b91}{options\_}->get<\textcolor{keywordtype}{bool}>(\textcolor{stringliteral}{"skip"});
256 
257     \textcolor{keywordtype}{size\_t} decoderLayers = \hyperlink{classmarian_1_1DecoderBase_a75375e7661a014fd15bbee3b0a047b91}{options\_}->get<\textcolor{keywordtype}{size\_t}>(\textcolor{stringliteral}{"dec-depth"});
258     \textcolor{keyword}{auto} cellType = \hyperlink{classmarian_1_1DecoderBase_a75375e7661a014fd15bbee3b0a047b91}{options\_}->get<std::string>(\textcolor{stringliteral}{"dec-cell"});
259 
260     \textcolor{keywordtype}{float} dropoutRnn = \hyperlink{classmarian_1_1DecoderBase_a808975d515f60a53096f6794c3dc61d4}{inference\_} ? 0 : \hyperlink{classmarian_1_1DecoderBase_a75375e7661a014fd15bbee3b0a047b91}{options\_}->get<\textcolor{keywordtype}{float}>(\textcolor{stringliteral}{"dropout-rnn"});
261     \textcolor{keywordtype}{float} dropoutTrg = \hyperlink{classmarian_1_1DecoderBase_a808975d515f60a53096f6794c3dc61d4}{inference\_} ? 0 : \hyperlink{classmarian_1_1DecoderBase_a75375e7661a014fd15bbee3b0a047b91}{options\_}->get<\textcolor{keywordtype}{float}>(\textcolor{stringliteral}{"dropout-trg"});
262 
263     \textcolor{keyword}{auto} stateHardAtt = std::dynamic\_pointer\_cast<DecoderStateHardAtt>(state);
264 
265     \textcolor{keyword}{auto} trgEmbeddings = stateHardAtt->getTargetEmbeddings();
266 
267     \textcolor{keyword}{auto} context = stateHardAtt->getEncoderState()->getContext();
268     \textcolor{keywordtype}{int} dimContext = context->shape()[1];
269     \textcolor{keywordtype}{int} dimSrcWords = context->shape()[2];
270 
271     \textcolor{keywordtype}{int} dimBatch = context->shape()[0];
272     \textcolor{keywordtype}{int} dimTrgWords = trgEmbeddings->shape()[2];
273     \textcolor{keywordtype}{int} dimBeam = trgEmbeddings->shape()[3];
274 
275     \textcolor{keywordflow}{if}(dropoutTrg) \{
276       \textcolor{keyword}{auto} trgWordDrop = graph->dropout(dropoutTrg, \{dimBatch, 1, dimTrgWords\});
277       trgEmbeddings = \hyperlink{namespacemarian_a268400392f22176821c7c4a36733b178}{dropout}(trgEmbeddings, \hyperlink{namespacemarian_1_1keywords_a201bea6bea8108889b63081132cc3cd7}{mask} = trgWordDrop);
278     \}
279 
280     \textcolor{keyword}{auto} flatContext = \hyperlink{namespacemarian_acd984f43188d0ae23c2a6ef13ae5293f}{reshape}(context, \{dimBatch * dimSrcWords, dimContext\});
281     \textcolor{keyword}{auto} attendedContext
282         = \hyperlink{namespacemarian_ace1e9a63d52edc363d70d661cf8d0257}{rows}(flatContext, stateHardAtt->getAttentionIndices());
283     attendedContext = \hyperlink{namespacemarian_acd984f43188d0ae23c2a6ef13ae5293f}{reshape}(attendedContext,
284                               \{dimBatch, dimContext, dimTrgWords, dimBeam\});
285 
286     \textcolor{keyword}{auto} rnnInputs = \hyperlink{namespacemarian_a2791a2c8f79a938f5cb22ae613680675}{concatenate}(\{trgEmbeddings, attendedContext\}, 
      \hyperlink{namespacemarian_1_1keywords_ace9158eabbddaca833133f12da98b9d6}{axis} = 1);
287     \textcolor{keywordtype}{int} dimInput = rnnInputs->shape()[1];
288 
289     \textcolor{keywordflow}{if}(!\hyperlink{classmarian_1_1DecoderHardSoftAtt_ae077a0f8f32a457c0c2c972ca4251ede}{rnn\_}) \{
290 
291       \textcolor{keyword}{auto} \hyperlink{namespacemarian_1_1rnn_aff1b115e415945b445f8d4a2068ec3e8}{rnn} = \hyperlink{namespacemarian_1_1rnn_aff1b115e415945b445f8d4a2068ec3e8}{rnn::rnn}(graph)
292                  (\textcolor{stringliteral}{"type"}, cellType)
293                  (\textcolor{stringliteral}{"dimInput"}, dimInput)
294                  (\textcolor{stringliteral}{"dimState"}, dimDecState)
295                  (\textcolor{stringliteral}{"dropout"}, dropoutRnn)
296                  (\textcolor{stringliteral}{"layer-normalization"}, layerNorm)
297                  (\textcolor{stringliteral}{"skip"}, skipDepth);
298 
299       \textcolor{keyword}{auto} attCell = \hyperlink{namespacemarian_1_1rnn_a55385034d5ad19187245bb2b564cb7eb}{rnn::stacked\_cell}(graph)
300                      .push\_back(\hyperlink{namespacemarian_1_1rnn_af723e51535e0b11de5b28fe19627a3fb}{rnn::cell}(graph)
301                                 (\textcolor{stringliteral}{"prefix"}, \hyperlink{classmarian_1_1DecoderBase_a043a90801b6bda9a45e309607136e947}{prefix\_} + \textcolor{stringliteral}{"\_cell1"}))
302                      .push\_back(\hyperlink{namespacemarian_1_1rnn_a57316dc4c756edb2a8dfabea7e50d92b}{rnn::attention}(graph)
303                                 (\textcolor{stringliteral}{"prefix"}, \hyperlink{classmarian_1_1DecoderBase_a043a90801b6bda9a45e309607136e947}{prefix\_})
304                                 .set\_state(state->getEncoderState()))
305                      .push\_back(\hyperlink{namespacemarian_1_1rnn_af723e51535e0b11de5b28fe19627a3fb}{rnn::cell}(graph)
306                                 (\textcolor{stringliteral}{"prefix"}, \hyperlink{classmarian_1_1DecoderBase_a043a90801b6bda9a45e309607136e947}{prefix\_} + \textcolor{stringliteral}{"\_cell2"})
307                                 (\textcolor{stringliteral}{"final"}, \textcolor{keyword}{true}));
308 
309       \hyperlink{namespacemarian_1_1rnn_aff1b115e415945b445f8d4a2068ec3e8}{rnn}.push\_back(attCell);
310       \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i = 0; i < decoderLayers - 1; ++i)
311         \hyperlink{namespacemarian_1_1rnn_aff1b115e415945b445f8d4a2068ec3e8}{rnn}.push\_back(\hyperlink{namespacemarian_1_1rnn_af723e51535e0b11de5b28fe19627a3fb}{rnn::cell}(graph)
312                       (\textcolor{stringliteral}{"prefix"}, \hyperlink{classmarian_1_1DecoderBase_a043a90801b6bda9a45e309607136e947}{prefix\_} + \textcolor{stringliteral}{"\_l"} + std::to\_string(i)));
313 
314       \hyperlink{classmarian_1_1DecoderHardSoftAtt_ae077a0f8f32a457c0c2c972ca4251ede}{rnn\_} = \hyperlink{namespacemarian_1_1rnn_aff1b115e415945b445f8d4a2068ec3e8}{rnn}.construct();
315 
316     \}
317 
318     \textcolor{keyword}{auto} decContext = \hyperlink{classmarian_1_1DecoderHardSoftAtt_ae077a0f8f32a457c0c2c972ca4251ede}{rnn\_}->transduce(rnnInputs, stateHardAtt->getStates());
319     \hyperlink{namespaceamunmt_a4fe2912e208820f8217fbcf229ebacf7}{rnn::States} decStates = \hyperlink{classmarian_1_1DecoderHardSoftAtt_ae077a0f8f32a457c0c2c972ca4251ede}{rnn\_}->lastCellStates();
320 
321     \textcolor{keyword}{auto} att = \hyperlink{classmarian_1_1DecoderHardSoftAtt_ae077a0f8f32a457c0c2c972ca4251ede}{rnn\_}->at(0)->as<rnn::StackedCell>()->at(1)->as<\hyperlink{namespacemarian_1_1rnn_ae9586d2236bd64dae0a644c58d9fc76e}{rnn::Attention}>();
322     \textcolor{keyword}{auto} alignedContext = att->\hyperlink{classmarian_1_1rnn_1_1GlobalAttention_ad518e4c82f56b8f95393dffa2df2288b}{getContext}();
323 
325     \textcolor{keyword}{auto} out = \hyperlink{namespacemarian_1_1mlp_a4d0fe240d31bdc33bcbdb5401de49e27}{mlp::mlp}(graph)
326                .push\_back(\hyperlink{namespacemarian_1_1mlp_a8c25b1e343bf78e66cd9e33e607efeb5}{mlp::dense}(graph)
327                           (\textcolor{stringliteral}{"prefix"}, \hyperlink{classmarian_1_1DecoderBase_a043a90801b6bda9a45e309607136e947}{prefix\_} + \textcolor{stringliteral}{"\_ff\_logit\_l1"})
328                           (\textcolor{stringliteral}{"dim"}, dimTrgEmb)
329                           (\textcolor{stringliteral}{"activation"}, \hyperlink{namespacemarian_1_1mlp_ac16d27a877d16d7394f2057aee439d72a5c0dbba3a6ee4ac0eb26cfee75ccb8b4}{mlp::act::tanh})
330                           (\textcolor{stringliteral}{"layer-normalization"}, layerNorm))
331                .push\_back(\hyperlink{namespacemarian_1_1mlp_a8c25b1e343bf78e66cd9e33e607efeb5}{mlp::dense}(graph)
332                           (\textcolor{stringliteral}{"prefix"}, \hyperlink{classmarian_1_1DecoderBase_a043a90801b6bda9a45e309607136e947}{prefix\_} + \textcolor{stringliteral}{"\_ff\_logit\_l2"})
333                           (\textcolor{stringliteral}{"dim"}, dimTrgVoc));
334 
335     \textcolor{keyword}{auto} logits = out->apply(rnnInputs, decContext, alignedContext);
336 
337     \textcolor{keywordflow}{return} New<DecoderStateHardAtt>(decStates,
338                                     logits,
339                                     stateHardAtt->getEncoderState(),
340                                     stateHardAtt->getAttentionIndices());
341   \}
\end{DoxyCode}


Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{de/d21/classmarian_1_1DecoderHardSoftAtt_aa3331fae45271298ce86ad6f6a5c9cf5_cgraph}
\end{center}
\end{figure}




\subsection{Member Data Documentation}
\index{marian\+::\+Decoder\+Hard\+Soft\+Att@{marian\+::\+Decoder\+Hard\+Soft\+Att}!rnn\+\_\+@{rnn\+\_\+}}
\index{rnn\+\_\+@{rnn\+\_\+}!marian\+::\+Decoder\+Hard\+Soft\+Att@{marian\+::\+Decoder\+Hard\+Soft\+Att}}
\subsubsection[{\texorpdfstring{rnn\+\_\+}{rnn_}}]{\setlength{\rightskip}{0pt plus 5cm}{\bf Ptr}$<$rnn\+::\+R\+NN$>$ marian\+::\+Decoder\+Hard\+Soft\+Att\+::rnn\+\_\+\hspace{0.3cm}{\ttfamily [protected]}}\hypertarget{classmarian_1_1DecoderHardSoftAtt_ae077a0f8f32a457c0c2c972ca4251ede}{}\label{classmarian_1_1DecoderHardSoftAtt_ae077a0f8f32a457c0c2c972ca4251ede}


Definition at line 238 of file hardatt.\+h.



The documentation for this class was generated from the following file\+:\begin{DoxyCompactItemize}
\item 
\hyperlink{hardatt_8h}{hardatt.\+h}\end{DoxyCompactItemize}
